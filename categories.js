function _defineProperty(e,t,s){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==typeof t?t:t+""}function _toPrimitive(e,t){if("object"!=typeof e||!e)return e;var s=e[Symbol.toPrimitive];if(void 0!==s){var i=s.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}var CategoriesWidget=function(){"use strict";function e(e){const t=e.querySelectorAll("a[href]");return Array.prototype.slice.call(t)}var t={keyTrap:function(e,t,s){9===e.keyCode&&(e.shiftKey?document.activeElement===t&&(e.preventDefault(),s.focus()):document.activeElement===s&&(e.preventDefault(),t.focus()))},firstTargetStop:function(t){return e(t)},lastTargetStop:function(t){const s=e(t);return s[s.length-1]}};const{keyTrap:s,firstTargetStop:i,lastTargetStop:r}=t;function n(e,t){return{x:t.x-e.x,y:t.y-e.y}}function o(e,t){return e.x*t.x+e.y*t.y}const a=class{constructor(e){this.super=e.super,this.els=document.querySelectorAll('[data-js="nav-categs-detail"]'),this.firstTabStop=[],this.lastTabStop=[],this.events={handleDetailKeyPress:this.handleDetailKeyPress.bind(this)},this.bindEvents(!0)}bindEvents(e){const t="".concat(e?"add":"remove","EventListener");this.els.forEach((e=>e["".concat(t)]("keydown",this.events.handleDetailKeyPress)))}findTabStops(){this.el.visibleAnchors=this.el.querySelector(".nav-categs-detail__body-content"),[this.firstTabStop]=i(this.el.visibleAnchors),this.lastTabStop=r(this.el.visibleAnchors)}handleDetailKeyPress(e){s(e,this.firstTabStop,this.lastTabStop)}show(e){this.el=[...this.els].find((t=>t.getAttribute("data-order")===e)),this.el.removeAttribute("hidden"),this.super.toggleDetailsVisibility(!0),this.findTabStops(),this.el.addEventListener("keydown",this.events.handleDetailKeyPress),this.el.focus({preventScroll:!0})}hide(){this.els.forEach((e=>e.setAttribute("hidden","hidden"))),this.super.toggleDetailsVisibility(!1),this.els.forEach((e=>e.removeEventListener("keydown",this.events.handleDetailKeyPress)))}},h=function(e,t,s,i){const r=n(t,i),a=n(t,s),h=n(t,e),l=o(r,r),d=o(r,a),c=o(r,h),u=o(a,a),g=o(a,h),v=1/(l*u-d*d),p=(u*c-d*g)*v,y=(l*g-d*c)*v;return p>=0&&y>=0&&p+y<1},{keyTrap:l,firstTargetStop:d,lastTargetStop:c}=t;const u=class{constructor(e){_defineProperty(this,"handleEscKey",(e=>{"Escape"===e.key&&(e.preventDefault(),e.stopPropagation(),this.detail.hide(),document.removeEventListener("keydown",this.handleEscKey),this.el.current.focus())})),this.detail=new a({super:this}),this.super=e.super,this.lastSelected=null,this.el=document.querySelector('[data-js="nav-categs-departments"]'),this.el.current={},this.mousePointsQueue=[],this.firstTabStop=[],this.lastTabStop=[],this.events={handleMove:this.handleMove.bind(this),handleLeave:this.handleLeave.bind(this),handleOver:this.handleOver.bind(this),handleClick:this.handleClick.bind(this),handleDepartmentsKeyPress:this.handleDepartmentsKeyPress.bind(this)},this.bindEvents(!0)}bindEvents(e){const t="".concat(e?"add":"remove","EventListener");this.el["".concat(t)]("mousemove",this.events.handleMove),this.el["".concat(t)]("mouseleave",this.events.handleLeave),this.el["".concat(t)]("mouseover",this.events.handleOver),this.el["".concat(t)]("click",this.events.handleClick),this.el["".concat(t)]("keydown",this.events.handleDepartmentsKeyPress)}render(){[this.firstTabStop]=d(this.el),this.lastTabStop=c(this.el),setTimeout((()=>{this.calculateOffsetPoints(),this.el.parentElement.focus({preventScroll:!0}),this.el.addEventListener("keydown",this.events.handleDepartmentsKeyPress)}),0)}cleanSelected(){this.lastSelected&&(this.lastSelected.classList.remove("nav-categs-departments__selected"),this.lastSelected.ariaExpanded=!1,this.lastSelected=null)}markSelected(e){e.classList.add("nav-categs-departments__selected"),e.ariaExpanded=!0,this.lastSelected=e}handleClick(e){"A"===e.target.tagName&&e.target.dataset&&e.target.dataset.order&&(e.preventDefault(),this.handleSelection(e.target,"click"))}handleDepartmentsKeyPress(e){l(e,this.firstTabStop,this.lastTabStop),"A"===e.target.tagName&&e.target.dataset&&e.target.dataset.order&&(32!==e.keyCode&&13!==e.keyCode||(e.preventDefault(),e.stopPropagation(),this.handleSelection(e.target,"keydown")))}handleOver(e){const{target:t}=e;if("A"===t.tagName){if(this.mousePointsQueue.length){const t={x:e.pageX,y:e.pageY};if(h(t,this.upperRight,this.lowerRight,this.mousePointsQueue[0]))return}this.handleSelection(t,"mouseover")}}handleSelection(e,t){this.el.current=e,this.cleanSelected();const s=e.getAttribute("data-order");s||"keydown"===t?(this.markSelected(this.el.current),this.detail.show(s),this.calculateOffsetPoints(),document.addEventListener("keydown",this.handleEscKey),this.super.setOverlay()):this.detail.hide()}toggleDetailsVisibility(e){this.super.toggleDetailsVisibility(e)}hide(){this.cleanSelected(),this.el.removeEventListener("keydown",this.events.handleDepartmentsKeyPress),this.detail.hide()}calculateOffsetPoints(){const e=this.el.getBoundingClientRect();this.upperRight={x:e.right+window.pageXOffset,y:e.top+window.pageYOffset},this.lowerRight={x:e.right+window.pageXOffset,y:e.bottom+window.pageYOffset}}handleMove(e){if(this.clearStillTimeout(),"A"!==e.target.tagName)return;this.setStillTimeout(e);const t={x:e.pageX,y:e.pageY};this.mousePointsQueue.push(t),this.mousePointsQueue.length>2&&this.mousePointsQueue.shift(),this.prevMousePoint&&this.prevMousePoint.x>t.x&&this.handleOver(e),this.prevMousePoint=t}handleLeave(){this.mousePointsQueue=[],this.clearStillTimeout()}clearStillTimeout(){this.stillTimeout&&clearTimeout(this.stillTimeout)}setStillTimeout(e){this.stillTimeout=setTimeout((()=>{this.lastSelected&&this.lastSelected===e.target||this.handleSelection(e.target,"timeout")}),100)}},g=()=>'\n  <div class="nav-categs-overlay" data-js="nav-categs-overlay" hidden></div>\n';const v=class{constructor(e){let{model:t,triggerSelector:s,bus:i}=e;if(this.trigger=document.querySelector(s),this.trigger.ariaExpanded=!1,this.trigger.setAttribute("role","button"),!this.trigger)throw new Error("CategoriesWidget: missing trigger element");return this.triggerParent=this.trigger.parentElement,this.renderOverlay(),this.el=document.querySelector('[data-js="nav-categs"]'),this.el.list=this.el.querySelector('[data-js="nav-categs-departments"'),this.setOverlay(),this.shown=!1,this.timeouts={show:null,hide:null},this.departments=new u({model:t,super:this}),this.bus=i,this.events={hideByEscaping:this.hideByEscaping.bind(this),showByKeyPress:this.showByKeyPress.bind(this),stopPropagation:this.stopPropagation.bind(this),preventDefault:this.preventDefault.bind(this),triggerMouseEnter:this.triggerMouseEnter.bind(this),elemsMouseEnter:this.elemsMouseEnter.bind(this),elemsMouseLeave:this.elemsMouseLeave.bind(this)},this.bindEvents(!0),this}bindEvents(e){const t="".concat(e?"add":"remove","EventListener");this.el["".concat(t)]("click",this.events.stopPropagation),this.trigger["".concat(t)]("click",this.events.triggerMouseEnter),this.trigger["".concat(t)]("mouseenter",this.events.triggerMouseEnter),this.trigger["".concat(t)]("keydown",this.events.showByKeyPress),[this.trigger,this.el].forEach((e=>{e["".concat(t)]("mouseenter",this.events.elemsMouseEnter)})),[this.trigger,this.el].forEach((e=>{e["".concat(t)]("mouseleave",this.events.elemsMouseLeave)}))}handleMouseLeave(){this.showTimerCleaner(),this.hideTimer()}hideByEscaping(e){if(27===e.keyCode){const e=document.querySelector(".nav-categs-detail"),t=!e||e.hidden;this.shown&&t&&(this.hideTimer(),this.trigger.focus())}}showByKeyPress(e){32!==e.keyCode&&13!==e.keyCode||(e.stopPropagation(),e.preventDefault(),this.shown||this.showTimer())}stopPropagation(e){e.stopPropagation()}preventDefault(e){e.preventDefault()}triggerMouseEnter(e){e.stopPropagation(),e.preventDefault(),this.shown||this.showTimer()}elemsMouseEnter(e){this.hideTimerCleaner(e)}elemsMouseLeave(e){this.handleMouseLeave(e)}renderOverlay(){document.body.insertAdjacentHTML("beforeend",g())}setOverlay(){this.overlay={el:document.querySelector('[data-js="nav-categs-overlay"]'),header:document.querySelector(".nav-header"),body:document.body},this.overlay.sizes={header:this.overlay.header.offsetHeight+this.overlay.header.offsetTop,body:this.overlay.body.offsetHeight};const e=parseInt(window.getComputedStyle(this.overlay.el).getPropertyValue("padding-bottom")),t=this.el.offsetHeight+e,s=this.overlay.sizes.body-this.overlay.sizes.header;this.overlay.el.style.minHeight="".concat(s>t?s:t,"px"),this.overlay.el.style.top="".concat(this.overlay.sizes.header,"px")}hide(){this.bus.emit("categories:hide:before"),this.trigger.ariaExpanded=!1,this.el.setAttribute("hidden","hidden"),this.shown=!1,this.overlay.el.setAttribute("hidden","hidden"),this.departments.hide(),this.triggerParent.classList.remove("nav-menu-chevron-down"),this.el.removeEventListener("keydown",this.events.hideByEscaping),this.trigger.addEventListener("keydown",this.events.showByKeyPress),this.bus.emit("categories:hide:after")}show(){this.bus.emit("categories:show:before"),this.trigger.ariaExpanded=!0,this.departments.render(),this.el.removeAttribute("hidden"),this.shown=!0,this.setOverlay(),this.overlay.el.removeAttribute("hidden"),this.triggerParent.classList.add("nav-menu-chevron-down"),this.el.addEventListener("keydown",this.events.hideByEscaping),this.trigger.removeEventListener("keydown",this.events.showByKeyPress),this.bus.emit("categories:show:after")}hideTimer(){this.timeouts.hide=window.setTimeout((()=>{this.hide()}),250)}hideTimerCleaner(){window.clearTimeout(this.timeouts.hide)}showTimer(){this.timeouts.show=window.setTimeout((()=>{this.show()}),250)}showTimerCleaner(){window.clearTimeout(this.timeouts.show)}toggleDetailsVisibility(e){const t=e?"add":"remove";this.el.classList["".concat(t)]("nav-categs--with-details")}};var p=class{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!e.endpoint)throw new Error("CategoriesWidget: missing endpoint.");if(this.bus=e.bus||window.freya,this.trigger=e.trigger||'[data-js="nav-menu-categories-trigger"]',this.endpoint=e.endpoint,this.isMobile=e.isMobile,!this.bus)throw new Error("CategoriesWidget: missing bus.");this.bus.on("categories:show",this.show.bind(this)),this.bus.on("categories:hide",this.hide.bind(this)),this.bus.on("header:shown",this.deactivate.bind(this)),this.bus.on("header:hidden",this.activate.bind(this)),this.fetchData()}fetchData(){try{this.categories=this.buildCategoriesComponent(void 0);const e="none"!==window.getComputedStyle(document.querySelector(".nav-menu")).getPropertyValue("display"),t=parseInt(window.getComputedStyle(document.querySelector(this.trigger),":before").getPropertyValue("opacity"));e&&t&&this.categories.show()}catch(e){return}}show(){return!!this.categories&&(this.categories.show(),this.categories)}hide(){return!!this.categories&&(this.categories.hide(),this.categories)}activate(){return!!this.categories&&(this.categories.bindEvents(!0),this.categories)}deactivate(){return!!this.categories&&(this.categories.bindEvents(!1),this.categories)}buildCategoriesComponent(e){const t={triggerSelector:this.trigger,model:e,bus:this.bus};return new v(t)}};return p}();
